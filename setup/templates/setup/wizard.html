<!-- setup/templates/setup/wizard.html -->
 
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã KPI</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .card { border: 1px solid #ddd; border-radius: 5px; padding: 20px; }
        .tab { display: none; }
        .tab.active { display: block; }
        input, button { margin: 10px 0; padding: 10px; width: 100%; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="card">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã KPI</h2>
        <div id="step1" class="tab active">
            <h3>1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö KPI</h3>
            <input type="text" id="db_host" placeholder="–•–æ—Å—Ç (localhost)" value="localhost">
            <input type="text" id="db_port" placeholder="–ü–æ—Ä—Ç (5432)" value="5432">
            <input type="text" id="db_name" placeholder="–ò–º—è –±–∞–∑—ã (kpi)" value="kpi">
            <input type="text" id="db_user" placeholder="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (postgres)" value="postgres">
            <input type="password" id="db_password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="testConnection('kpi')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
            <div id="kpi_result"></div>
            <button onclick="nextStep()">–î–∞–ª–µ–µ</button>
        </div>
        
        <div id="step2" class="tab">
            <h3>2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ú–ò–° (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
            <label><input type="checkbox" id="enable_mis" checked> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ú–ò–°</label>
            <div id="mis_fields">
                <input type="text" id="mis_host" placeholder="–•–æ—Å—Ç –ú–ò–°">
                <input type="text" id="mis_port" placeholder="–ü–æ—Ä—Ç (5432)" value="5432">
                <input type="text" id="mis_name" placeholder="–ò–º—è –±–∞–∑—ã">
                <input type="text" id="mis_user" placeholder="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
                <input type="password" id="mis_password" placeholder="–ü–∞—Ä–æ–ª—å">
                <button onclick="testConnection('mis')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                <div id="mis_result"></div>
            </div>
            <button onclick="prevStep()">–ù–∞–∑–∞–¥</button>
            <button onclick="nextStep()">–î–∞–ª–µ–µ</button>
        </div>
        
        <div id="step3" class="tab">
            <h3>3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</h3>
            <p>–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.</p>
            <button onclick="saveConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button onclick="prevStep()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        let currentStep = 1;
        
        function showStep(step) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }
        
        function nextStep() {
            if (currentStep < 3) {
                currentStep++;
                showStep(currentStep);
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }
        
        function testConnection(type) {
            const resultDiv = document.getElementById(`${type}_result`);
            resultDiv.innerHTML = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            
            const data = new FormData();
            data.append('db_type', type);
            
            if (type === 'kpi') {
                data.append('db_name', document.getElementById('db_name').value);
                data.append('db_user', document.getElementById('db_user').value);
                data.append('db_password', document.getElementById('db_password').value);
                data.append('db_host', document.getElementById('db_host').value);
                data.append('db_port', document.getElementById('db_port').value);
            } else {
                data.append('mis_name', document.getElementById('mis_name').value);
                data.append('mis_user', document.getElementById('mis_user').value);
                data.append('mis_password', document.getElementById('mis_password').value);
                data.append('mis_host', document.getElementById('mis_host').value);
                data.append('mis_port', document.getElementById('mis_port').value);
            }
            
            fetch('/test/', {
                method: 'POST',
                body: data
            })
            .then(r => r.json())
            .then(data => {
                resultDiv.innerHTML = data.success ? 
                    '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ' : 
                    '‚ùå –û—à–∏–±–∫–∞: ' + data.message;
                resultDiv.className = data.success ? 'success' : 'error';
            });
        }
        
        function saveConfig() {
            const data = new FormData();
            data.append('db_name', document.getElementById('db_name').value);
            data.append('db_user', document.getElementById('db_user').value);
            data.append('db_password', document.getElementById('db_password').value);
            data.append('db_host', document.getElementById('db_host').value);
            data.append('db_port', document.getElementById('db_port').value);
            
            if (document.getElementById('enable_mis').checked) {
                data.append('mis_name', document.getElementById('mis_name').value);
                data.append('mis_user', document.getElementById('mis_user').value);
                data.append('mis_password', document.getElementById('mis_password').value);
                data.append('mis_host', document.getElementById('mis_host').value);
                data.append('mis_port', document.getElementById('mis_port').value);
            }
            
            fetch('/save/', {
                method: 'POST',
                body: data
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º...');
                    setTimeout(() => location.href = '/', 1000);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
                }
            });
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –ø–æ–ª–µ–π –ú–ò–°
        document.getElementById('enable_mis').addEventListener('change', function() {
            document.getElementById('mis_fields').style.display = 
                this.checked ? 'block' : 'none';
        });
    </script>
</body>
</html>