<!--** apps\dashboard\templates\dashboard\doctor_dashboard.html **-->

{% extends 'dashboard/base.html' %}

{% block title %}–ú–æ–π –¥–∞—à–±–æ—Ä–¥ - KPI System{% endblock %}

{% block page_title %}–ú–æ–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">–¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥: {{ current_period }}</h5>
                <p class="card-text">–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–∞—à–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    {% for result in kpi_results %}
    <div class="col-md-4 mb-4">
        <div class="card kpi-card shadow-sm">
            <div class="card-body">
                <h6 class="card-title">{{ result.plan_type.name }}</h6>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if result.percentage >= 90 %}
                        <h3 class="mb-0 text-success">{{ result.percentage }}%</h3>
                        {% elif result.percentage >= 70 %}
                        <h3 class="mb-0 text-warning">{{ result.percentage }}%</h3>
                        {% else %}
                        <h3 class="mb-0 text-danger">{{ result.percentage }}%</h3>
                        {% endif %}
                        <small class="text-muted">
                            –§–∞–∫—Ç: {{ result.actual_value }} / –ü–ª–∞–Ω: {{ result.plan_value }}
                        </small>
                    </div>
                    <div class="text-end">
                        <!-- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –±–µ–∑ inline —Å—Ç–∏–ª–µ–π -->
                        <div class="progress" style="width: 80px;">
                            {% if result.percentage >= 90 %}
                            <div class="progress-bar bg-success" role="progressbar"></div>
                            {% elif result.percentage >= 70 %}
                            <div class="progress-bar bg-warning" role="progressbar"></div>
                            {% else %}
                            <div class="progress-bar bg-danger" role="progressbar"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info">
            <h5>üìä –î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã</h5>
            <p>KPI –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥ {{ current_period }} –µ—â–µ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã.</p>
            <a href="/admin/kpi_calc/kpiresult/" class="btn btn-primary btn-sm">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å—á–µ—Ç–∞–º
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% if chart_data %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h5>
            </div>
            <div class="card-body">
                <canvas id="kpiChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
{% if chart_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('kpiChart').getContext('2d');
    
    // –ü—Ä–æ—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    const chartData = {
        labels: ['–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å 1', '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å 2', '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å 3'],
        datasets: [{
            label: '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞, %',
            data: [85, 92, 78],
            backgroundColor: ['#28a745', '#28a745', '#ffc107'],
            borderColor: ['#28a745', '#28a745', '#ffc107'],
            borderWidth: 1
        }]
    };
    
    const kpiChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, %'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}